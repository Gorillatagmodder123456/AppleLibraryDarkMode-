-- vars
local lib = {}
local sections = {}
local workareas = {}
local visible = true

local function tp(ins, pos, time, thing)
    game:GetService("TweenService"):Create(ins, TweenInfo.new(time or 0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.InOut), {Position = pos}):Play()
end

function lib:init(ti, dosplash, visiblekey, deleteprevious)
    local scrgui
    local cg = game:GetService("CoreGui")

    -- GUI Parent Handling
    if syn then
        if cg:FindFirstChild("ScreenGui") and deleteprevious then
            tp(cg.ScreenGui.main, cg.ScreenGui.main.Position + UDim2.new(0,0,2,0), 0.5)
            game:GetService("Debris"):AddItem(cg.ScreenGui, 1)
        end
        scrgui = Instance.new("ScreenGui")
        syn.protect_gui(scrgui)
        scrgui.Parent = cg
    elseif gethui then
        local hui = gethui()
        if hui:FindFirstChild("ScreenGui") and deleteprevious then
            hui.ScreenGui.main:TweenPosition(hui.ScreenGui.main.Position + UDim2.new(0,0,2,0), "InOut", "Quart", 0.5)
            game:GetService("Debris"):AddItem(hui.ScreenGui, 1)
        end
        scrgui = Instance.new("ScreenGui")
        scrgui.Parent = hui
    else
        if cg:FindFirstChild("ScreenGui") and deleteprevious then
            tp(cg.ScreenGui.main, cg.ScreenGui.main.Position + UDim2.new(0,0,2,0), 0.5)
            game:GetService("Debris"):AddItem(cg.ScreenGui, 1)
        end
        scrgui = Instance.new("ScreenGui")
        scrgui.Parent = cg
    end
    scrgui.Name = "ScreenGui" -- Consistent name

    -- Splash Screen
    if dosplash then
        local splash = Instance.new("Frame")
        splash.Name = "splash"
        splash.Parent = scrgui
        splash.AnchorPoint = Vector2.new(0.5, 0.5)
        splash.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        splash.BackgroundTransparency = 0.2
        splash.Position = UDim2.new(0.5, 0, 2, 0)
        splash.Size = UDim2.new(0, 340, 0, 340)
        splash.ZIndex = 40

        local uc = Instance.new("UICorner", splash)
        uc.CornerRadius = UDim.new(0, 18)

        local sicon = Instance.new("ImageLabel", splash)
        sicon.AnchorPoint = Vector2.new(0.5, 0.5)
        sicon.BackgroundTransparency = 1
        sicon.Position = UDim2.new(0.5, 0, 0.5, 0)
        sicon.Size = UDim2.new(0, 191, 0, 190)
        sicon.ZIndex = 40
        sicon.Image = "rbxassetid://12621719043"
        sicon.ScaleType = Enum.ScaleType.Fit

        local ug = Instance.new("UIGradient", sicon)
        ug.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0.00, Color3.fromRGB(50, 50, 50)),
            ColorSequenceKeypoint.new(0.01, Color3.fromRGB(100, 100, 100)),
            ColorSequenceKeypoint.new(0.47, Color3.fromRGB(120, 120, 120)),
            ColorSequenceKeypoint.new(1.00, Color3.fromRGB(180, 180, 180))
        }
        ug.Rotation = 90

        local sshadow = Instance.new("ImageLabel", splash)
        sshadow.AnchorPoint = Vector2.new(0.5, 0.5)
        sshadow.BackgroundTransparency = 1
        sshadow.Position = UDim2.new(0.5, 0, 0.5, 0)
        sshadow.Size = UDim2.new(1.2, 0, 1.2, 0)
        sshadow.ZIndex = 39
        sshadow.Image = "rbxassetid://313486536"
        sshadow.ImageColor3 = Color3.new(0,0,0)
        sshadow.ImageTransparency = 0.6

        splash:TweenPosition(UDim2.new(0.5, 0, 0.5, 0), "InOut", "Quart", 1)
        task.wait(2)
        splash:TweenPosition(UDim2.new(0.5, 0, 2, 0), "InOut", "Quart", 1)
        game:GetService("Debris"):AddItem(splash, 1)
    end

    -- Main Window
    local main = Instance.new("Frame")
    main.Name = "main"
    main.Parent = scrgui
    main.AnchorPoint = Vector2.new(0.5, 0.5)
    main.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    main.BackgroundTransparency = 0.1
    main.Position = UDim2.new(0.5, 0, 2, 0)
    main.Size = UDim2.new(0, 721, 0, 584)

    local uc = Instance.new("UICorner", main)
    uc.CornerRadius = UDim.new(0, 18)

    -- Dragging
    local UserInputService = game:GetService("UserInputService")
    local dragging, dragInput, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    main.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = main.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    main.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and input == dragInput then
            update(input)
        end
    end)

    -- Traffic Lights (Left Top)
    local buttons = Instance.new("Frame")
    buttons.Name = "buttons"
    buttons.Parent = main
    buttons.BackgroundTransparency = 1
    buttons.Position = UDim2.new(0, 15, 0, 15)
    buttons.Size = UDim2.new(0, 105, 0, 57)

    local ull3 = Instance.new("UIListLayout", buttons)
    ull3.FillDirection = Enum.FillDirection.Horizontal
    ull3.HorizontalAlignment = Enum.HorizontalAlignment.Left
    ull3.Padding = UDim.new(0, 10)
    ull3.VerticalAlignment = Enum.VerticalAlignment.Center

    local close = Instance.new("TextButton", buttons)
    close.Name = "close"
    close.BackgroundColor3 = Color3.fromRGB(255, 95, 87)
    close.Size = UDim2.new(0, 13, 0, 13)
    close.AutoButtonColor = false
    close.Text = ""
    close.MouseEnter:Connect(function() close.BackgroundColor3 = Color3.fromRGB(255, 120, 110) end)
    close.MouseLeave:Connect(function() close.BackgroundColor3 = Color3.fromRGB(255, 95, 87) end)
    close.MouseButton1Click:Connect(function() scrgui:Destroy() end)
    Instance.new("UICorner", close).CornerRadius = UDim.new(1, 0)

    local minimize = Instance.new("TextButton", buttons)
    minimize.Name = "minimize"
    minimize.BackgroundColor3 = Color3.fromRGB(255, 189, 49)
    minimize.Size = UDim2.new(0, 13, 0, 13)
    minimize.AutoButtonColor = false
    minimize.Text = ""
    minimize.MouseEnter:Connect(function() minimize.BackgroundColor3 = Color3.fromRGB(255, 200, 70) end)
    minimize.MouseLeave:Connect(function() minimize.BackgroundColor3 = Color3.fromRGB(255, 189, 49) end)

    local resize = Instance.new("TextButton", buttons)
    resize.Name = "resize"
    resize.BackgroundColor3 = Color3.fromRGB(40, 200, 65)
    resize.Size = UDim2.new(0, 13, 0, 13)
    resize.AutoButtonColor = false
    resize.Text = ""
    resize.MouseEnter:Connect(function() resize.BackgroundColor3 = Color3.fromRGB(60, 215, 85) end)
    resize.MouseLeave:Connect(function() resize.BackgroundColor3 = Color3.fromRGB(40, 200, 65) end)
    Instance.new("UICorner", resize).CornerRadius = UDim.new(1, 0)

    -- Title
    local title = Instance.new("TextLabel", main)
    title.BackgroundTransparency = 1
    title.Position = UDim2.new(0, 140, 0, 15) -- After traffic lights
    title.Size = UDim2.new(1, -280, 0, 40)
    title.Font = Enum.Font.GothamBold
    title.Text = ti or "Window"
    title.TextColor3 = Color3.fromRGB(220, 220, 220)
    title.TextSize = 16
    title.TextXAlignment = Enum.TextXAlignment.Left

    -- Workarea
    local workarea = Instance.new("Frame", main)
    workarea.Name = "workarea"
    workarea.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    workarea.Position = UDim2.new(0, 263, 0, 0) -- 721 * 0.364 ≈ 263
    workarea.Size = UDim2.new(0, 458, 1, 0)
    Instance.new("UICorner", workarea).CornerRadius = UDim.new(0, 18)

    -- Hide left corner bleed
    local cornerhider = Instance.new("Frame", workarea)
    cornerhider.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    cornerhider.Size = UDim2.new(0, 18, 1, 0)
    cornerhider.Position = UDim2.new(0, -18, 0, 0)

    -- Search Bar
    local search = Instance.new("Frame", main)
    search.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    search.Position = UDim2.new(0, 18, 0, 70)
    search.Size = UDim2.new(0, 225, 0, 34)
    Instance.new("UICorner", search).CornerRadius = UDim.new(0, 9)

    local searchicon = Instance.new("ImageButton", search)
    searchicon.BackgroundTransparency = 1
    searchicon.Position = UDim2.new(0, 8, 0, 6)
    searchicon.Size = UDim2.new(0, 24, 0, 21)
    searchicon.Image = "rbxassetid://2804603863"
    searchicon.ImageColor3 = Color3.fromRGB(180, 180, 180)

    local searchtextbox = Instance.new("TextBox", search)
    searchtextbox.BackgroundTransparency = 1
    searchtextbox.Position = UDim2.new(0, 40, 0, 0)
    searchtextbox.Size = UDim2.new(1, -48, 1, 0)
    searchtextbox.Font = Enum.Font.Gotham
    searchtextbox.PlaceholderText = "Search"
    searchtextbox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
    searchtextbox.TextColor3 = Color3.fromRGB(220, 220, 220)
    searchtextbox.TextSize = 18
    searchtextbox.TextXAlignment = Enum.TextXAlignment.Left

    searchicon.MouseButton1Click:Connect(function() searchtextbox:CaptureFocus() end)

    -- Sidebar
    local sidebar = Instance.new("ScrollingFrame", main)
    sidebar.BackgroundTransparency = 1
    sidebar.Position = UDim2.new(0, 18, 0, 120)
    sidebar.Size = UDim2.new(0, 233, 0, 463)
    sidebar.AutomaticCanvasSize = Enum.AutomaticSize.Y
    sidebar.ScrollBarThickness = 2

    local ull2 = Instance.new("UIListLayout", sidebar)
    ull2.Padding = UDim.new(0, 5)
    ull2.SortOrder = Enum.SortOrder.LayoutOrder

    -- Search Filtering (optimized)
    searchtextbox:GetPropertyChangedSignal("Text"):Connect(function()
        local query = string.upper(searchtextbox.Text)
        for _, btn in pairs(sidebar:GetChildren()) do
            if btn:IsA("TextButton") and btn.Name == "sidebar2" then
                if query == "" or string.find(string.upper(btn.Text), query) then
                    btn.Visible = true
                else
                    btn.Visible = false
                end
            end
        end
    end)

    -- Modals (fixed darkness parenting)
    local function createModal(name, twoButtons)
        local modal = Instance.new("Frame", main)
        modal.Name = name
        modal.AnchorPoint = Vector2.new(0.5, 0.5)
        modal.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        modal.Position = UDim2.new(0.5, 0, 0.5, 0)
        modal.Size = UDim2.new(0, 304, 0, 362)
        modal.Visible = false
        modal.ZIndex = 10

        Instance.new("UICorner", modal).CornerRadius = UDim.new(0, 18)

        -- Darkness backdrop (now covers whole main)
        local darkness = Instance.new("Frame", main)
        darkness.Name = name .. "darkness"
        darkness.AnchorPoint = Vector2.new(0.5, 0.5)
        darkness.BackgroundColor3 = Color3.new(0,0,0)
        darkness.BackgroundTransparency = 0.7
        darkness.Position = UDim2.new(0.5, 0, 0.5, 0)
        darkness.Size = UDim2.new(1, 0, 1, 0)
        darkness.ZIndex = 9
        darkness.Visible = false
        Instance.new("UICorner", darkness).CornerRadius = UDim.new(0, 18)

        -- Shadow
        local shadow = Instance.new("ImageLabel", modal)
        shadow.AnchorPoint = Vector2.new(0.5, 0.5)
        shadow.BackgroundTransparency = 1
        shadow.Position = UDim2.new(0.5, 0, 0.5, 0)
        shadow.Size = UDim2.new(1.2, 0, 1.2, 0)
        shadow.ZIndex = 9
        shadow.Image = "rbxassetid://313486536"
        shadow.ImageColor3 = Color3.new(0,0,0)

        return modal, darkness
    end

    local notif, notifdark = createModal("notif", false)
    local notif2, notif2dark = createModal("notif2", true)

    -- Add elements to notif and notif2 (same as yours, omitted for brevity)
    -- ... (your icon, title, text, buttons code here — unchanged except parenting)

    -- Animate in main window
    tp(main, UDim2.new(0.5, 0, 0.5, 0), 1)

    local window = {}

    -- Toggle Visibility (fixed debounce)
    local hiding = false
    function window:ToggleVisible()
        if hiding then return end
        hiding = true
        visible = not visible

        if visible then
            tp(main, UDim2.new(0.5, 0, 0.5, 0), 0.5)
        else
            tp(main, UDim2.new(0.5, 0, 2, 0), 0.5)
        end

        task.delay(0.5, function() hiding = false end)
    end

    if visiblekey then
        minimize.MouseButton1Click:Connect(window.ToggleVisible)
        UserInputService.InputBegan:Connect(function(input)
            if input.KeyCode == visiblekey then
                window:ToggleVisible()
            end
        end)
    end

    function window:GreenButton(callback)
        if _G.gbutton_123123 then _G.gbutton_123123:Disconnect() end
        _G.gbutton_123123 = resize.MouseButton1Click:Connect(callback)
    end

    function window:TempNotify(text1, text2, icon)
        -- Stack from bottom-right
        local count = #scrgui:GetChildren(i => i.Name == "tempnotif")
        local tempnotif = Instance.new("Frame")
        tempnotif.Name = "tempnotif"
        tempnotif.Parent = scrgui
        tempnotif.AnchorPoint = Vector2.new(1, 1)
        tempnotif.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        tempnotif.BackgroundTransparency = 0.2
        tempnotif.Position = UDim2.new(1, 20, 1, -20 - (count * 130))
        tempnotif.Size = UDim2.new(0, 447, 0, 117)
        tempnotif.ZIndex = 20

        -- Animate in
        tempnotif.Position = tempnotif.Position + UDim2.new(0, 500, 0, 0)
        tp(tempnotif, tempnotif.Position - UDim2.new(0, 500, 0, 0), 0.4)

        -- Add your labels/icon/shadow here (same as original)

        game:GetService("Debris"):AddItem(tempnotif, 5)
    end

    function window:Notify(txt1, txt2, b1, icohn, callback)
        if notif.Visible or notif2.Visible then return "Already visible" end
        notifdark.Visible = true
        notif.Visible = true
        -- set text, icon, button, connect callback...
    end

    function window:Notify2(txt1, txt2, b1, b2, icohn, callback1, callback2)
        if notif.Visible or notif2.Visible then return "Already visible" end
        notif2dark.Visible = true
        notif2.Visible = true
        -- set text, buttons, connect callbacks...
    end

    function window:Divider(name)
        local div = Instance.new("TextLabel", sidebar)
        div.BackgroundTransparency = 1
        div.Size = UDim2.new(1, -10, 0, 26)
        div.Font = Enum.Font.GothamSemibold
        div.Text = name
        div.TextColor3 = Color3.fromRGB(150, 150, 150)
        div.TextSize = 14
        div.TextXAlignment = Enum.TextXAlignment.Left
    end

    function window:Section(name)
        local sidebarBtn = Instance.new("TextButton", sidebar)
        sidebarBtn.Name = "sidebar2"
        sidebarBtn.BackgroundColor3 = Color3.fromRGB(0, 122, 255)
        sidebarBtn.BackgroundTransparency = 1
        sidebarBtn.Size = UDim2.new(1, -10, 0, 37)
        sidebarBtn.Font = Enum.Font.Gotham
        sidebarBtn.Text = name
        sidebarBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
        sidebarBtn.TextSize = 17
        sidebarBtn.AutoButtonColor = false
        Instance.new("UICorner", sidebarBtn).CornerRadius = UDim.new(0, 9)

        -- Hover effect
        sidebarBtn.MouseEnter:Connect(function() if sidebarBtn.BackgroundTransparency == 1 then sidebarBtn.BackgroundTransparency = 0.9 end end)
        sidebarBtn.MouseLeave:Connect(function() if sidebarBtn.BackgroundTransparency == 0.9 then sidebarBtn.BackgroundTransparency = 1 end end)

        local workareaMain = Instance.new("ScrollingFrame", workarea)
        workareaMain.BackgroundTransparency = 1
        workareaMain.Position = UDim2.new(0, 18, 0, 56)
        workareaMain.Size = UDim2.new(1, -36, 1, -112)
        workareaMain.CanvasSize = UDim2.new(0, 0, 0, 0)
        workareaMain.AutomaticCanvasSize = Enum.AutomaticSize.Y
        workareaMain.ScrollBarThickness = 2
        workareaMain.Visible = false

        local ull = Instance.new("UIListLayout", workareaMain)
        ull.Padding = UDim.new(0, 8)
        ull.HorizontalAlignment = Enum.HorizontalAlignment.Center

        table.insert(sections, sidebarBtn)
        table.insert(workareas, workareaMain)

        local sec = {}

        function sec:Select()
            for _, v in ipairs(sections) do
                v.BackgroundTransparency = 1
                v.TextColor3 = Color3.fromRGB(200, 200, 200)
            end
            sidebarBtn.BackgroundTransparency = 0.8
            sidebarBtn.TextColor3 = Color3.new(1,1,1)

            for _, v in ipairs(workareas) do v.Visible = false end
            workareaMain.Visible = true
        end

        sidebarBtn.MouseButton1Click:Connect(function() sec:Select() end)

        -- Add your sec:Button, :Label, :Switch, :TextField, :Divider functions here (unchanged)

        return sec
    end

    return window
end

return lib
